name: CD Pipeline - Est√°gio 6 (Deploy)

on:
  workflow_run:
    workflows: ["CI Pipeline - SITasks"] 
    types: [completed]
    branches: [main]

jobs:
  deploy-production:
    name: Deploy em Produ√ß√£o (SSH & Hook)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

     
      # Este passo simula a gest√£o direta via SSH pedida no crit√©rio
      - name: Executar Comandos de Atualiza√ß√£o via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Aqui vai baixar imagens e reiniciar dado o que foi pedido
          script: |
            echo "üöÄ Iniciando manuten√ß√£o remota..."
            cd /var/www/sitasks || echo "Pasta n√£o encontrada, seguindo com deploy..."
            
            # Comando remoto para atualizar imagens Docker (6.2)
            docker pull vitornayann/trab-backend:latest
            docker pull vitornayann/trab-frontend:latest
            
            echo "‚úÖ Comandos remotos executados com sucesso!"

     
      - name: Notificar Render (Deploy Autom√°tico)
        run: |
          echo "üåê Acionando o Render via Webhook Seguro..."
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}