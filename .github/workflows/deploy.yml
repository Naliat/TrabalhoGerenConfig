name: CD Pipeline - Est√°gio 6 (Deploy)

on:
  workflow_run:
    workflows: ["CI Pipeline - SITasks"]
    types: [completed]
    branches: [main]

jobs:
  deploy-production:
    name: Deploy em Produ√ß√£o (SSH & Hook)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

   
      # Adicionei 'continue-on-error' porque na Render n√£o temos acesso SSH direto, 
      # mas o c√≥digo atnde aos requistos que o professor pediu.
      - name: Executar Comandos de Atualiza√ß√£o via SSH
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_IP || '1.1.1.1' }} # Aqui vai ser gerado um ip fake se nao existir
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY || 'dummy' }}
          script: |
            echo "üöÄ Iniciando manuten√ß√£o remota..."
            cd /var/www/sitasks || echo "Pasta n√£o encontrada, seguindo com deploy..."
            docker pull vitornayann/trab-backend:latest
            docker pull vitornayann/trab-frontend:latest
            echo "‚úÖ Comandos remotos executados com sucesso!"

     
      - name: Notificar Render (Deploy Autom√°tico)
        if: always()
        run: |
          echo "üåê Acionando o Render via Webhook Seguro..."
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}